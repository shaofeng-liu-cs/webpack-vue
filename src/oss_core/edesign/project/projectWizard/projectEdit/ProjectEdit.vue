<template>
  <div class=" handleEditProjectBox">
    <div class="project-edit-loading">
      <div class="blockUI ui-widget-overlay " tabindex="0" style="position: fixed; z-index: 100100"></div>
      <div class="blockUI  blockPage" style="position: fixed; z-index: 100110; margin-left: -60.5px;">
        <span class="loading"></span>
        <span class="blockUI-content ">
          {{ $t('LOADING') }}
        </span>
      </div>
    </div>
    <div class="edit-content-body">
      <div class="editProjectFromBox">
        <el-scrollbar>
          <el-form ref="editForm" class="form-content-box" label-position="top" :model="formValue" :rules="rules">
            <div class="box-head-title">
              <span class="left-title">
                {{ $t('PROJECT_BASIC_INFROMATION') }}
              </span>
            </div>
            <div class="form-it-list">
              <span class="form-it-span">
                <el-form-item prop="projectName" :label="$t('E_PROJECTDETAIL_NAME')">
                  <el-input size="mini" v-model="formValue.projectName" data-csname="projectName" :disabled="isDisabled"></el-input>
                </el-form-item>
              </span>
              <span class="form-it-span">
                <el-form-item prop="interOrderId" :label="$t('PROJECT_INTER_ORDER_ID')">
                  <span class="disable-label" v-if="isDisabled">{{ formValue.interOrderId || '-' }}</span>
                  <el-input size="mini" v-else v-model="formValue.interOrderId" data-csname="interOrderId"></el-input>
                </el-form-item>
              </span>
              <span class="form-it-span">
                <el-form-item prop="operationType" :label="$t('E_PROJECTDETAIL_TYPE')">
                  <el-select data-csname="operationType" v-model="formValue.operationType" :placeholder="$t('PLEASE_SELECT')" :disabled="isDisabled">
                    <el-option v-for="item in proTypeSettingData" :key="item.code" :label="item.name" :value="item.code"> </el-option>
                  </el-select>
                </el-form-item>
              </span>
              <span class="form-it-span">
                <el-form-item prop="regionId" :label="$t('REGION')">
                  <el-select
                    filterable
                    data-csname="regionId"
                    v-model="formValue.regionId"
                    :placeholder="$t('PLEASE_SELECT')"
                    :disabled="isDisabled || !!projectInfo.projectId"
                    @change="changeArea"
                  >
                    <el-option v-for="item in citySettingData" :key="item.AREA_ID" :label="item.AREA_NAME" :value="item.AREA_ID"> </el-option>
                  </el-select>
                </el-form-item>
              </span>
              <span class="form-it-span">
                <el-form-item prop="projectDesc" :label="$t('OSP_TASK_DESCRIPTION')">
                  <span class="disable-label" v-if="isDisabled">{{ formValue.projectDesc || '-' }}</span>
                  <el-input size="mini" v-model="formValue.projectDesc" data-csname="projectDesc" v-else></el-input>
                </el-form-item>
              </span>
            </div>

            <div class="box-head-title">
              <span class="left-title">
                {{ $t('PROJECT_TARGET') }}
              </span>
            </div>
            <div class="form-it-list">
              <span class="form-it-span">
                <el-form-item prop="extHpType" :label="$t('PROJECT_HP_TYPE')">
                  <el-select data-csname="extHpType" v-model="formValue.extHpType" :placeholder="$t('PLEASE_SELECT')" :disabled="isDisabled">
                    <el-option v-for="item in hpTypeSettingData" :key="item.code" :label="item.name" :value="item.code"> </el-option>
                  </el-select>
                </el-form-item>
              </span>
              <span class="form-it-span">
                <el-form-item prop="extHpRedundancyRatio" :label="$t('PROJECT_HP_REDUNDANCY_RATIO')" class="is-required">
                  <el-input
                    size="mini"
                    type="number"
                    v-model="formValue.extHpRedundancyRatio"
                    data-csname="extHpRedundancyRatio"
                    :disabled="isDisabled"
                  ></el-input>
                </el-form-item>
              </span>
              <span class="form-it-span">
                <el-form-item prop="extCoverHps" :label="$t('PROJECT_COVER_HPS')" class="is-required">
                  <el-input
                    size="mini"
                    type="number"
                    v-model="formValue.extCoverHps"
                    data-csname="extCoverHps"
                    @change="hpsChange"
                    :disabled="isDisabled"
                  ></el-input>
                </el-form-item>
              </span>
              <span class="form-it-span">
                <el-form-item prop="extUserDensity" :label="$t('PROJECT_USER_DENSITY')">
                  <span class="disable-label">{{ formValue.extUserDensity || '-' }}</span>
                  <!-- <el-input size="mini" v-model="formValue.extUserDensity" data-csname="extUserDensity" :disabled="true"></el-input> -->
                </el-form-item>
              </span>
              <span class="form-it-span">
                <el-form-item prop="extCoverageArea" :label="`${$t('PROJECT_COVERAGE_AREA')}(KMÂ²)`">
                  <span class="disable-label">{{ formValue.extCoverageArea || '-' }}</span>
                  <!-- <el-input size="mini" v-model="formValue.extCoverageArea" data-csname="extCoverageArea" :disabled="true"></el-input> -->
                </el-form-item>
              </span>
              <span class="form-it-span" v-if="projectInfo.projectId">
                <el-form-item prop="extNumberOfMdu" :label="$t('PROJECT_NUMBER_OF_MDU')">
                  <span class="disable-label">{{ formValue.extNumberOfMdu || '-' }}</span>
                  <!-- <el-input size="mini" v-model="formValue.extNumberOfMdu" data-csname="extNumberOfMdu" :disabled="true"></el-input> -->
                </el-form-item>
              </span>
              <span class="form-it-span" v-if="projectInfo.projectId">
                <el-form-item prop="extNumberOfSdu" :label="$t('PROJECT_NUMBER_OF_SDU')">
                  <span class="disable-label">{{ formValue.extNumberOfSdu || '-' }}</span>
                  <!-- <el-input size="mini" v-model="formValue.extNumberOfSdu" data-csname="extNumberOfSdu" :disabled="true"></el-input> -->
                </el-form-item>
              </span>
              <span class="form-it-span" v-if="projectInfo.projectId">
                <el-form-item prop="extNumberOfBuilding" :label="$t('PROJECT_NUMBER_OF_BUILDING')">
                  <span class="disable-label">{{ formValue.extNumberOfBuilding || '-' }}</span>
                  <!-- <el-input size="mini" v-model="formValue.extNumberOfBuilding" data-csname="extNumberOfBuilding" :disabled="true"></el-input> -->
                </el-form-item>
              </span>
            </div>

            <div class="box-head-title">
              <span class="left-title">
                {{ $t('PROJECT_ATTACHMENT') }}
              </span>
              <span class="right-btn" v-if="!isDisabled">
                <el-button type="primary" size="mini2" @click="uploadFile" data-csname="uploadFiles">{{ $t('UPLOAD') }}</el-button>
                <input type="file" name="upfile" id="uploadFileInput" style="display:none;" @change="chooseFile" :disabled="isDisabled" />
              </span>
            </div>
            <div class="upload-files">
              <span class="fileItem" v-for="(file, i) in projectInfo.projectDocList" :key="i">
                <span class="fileContent">
                  <span class="fileName">{{ file.docName }}</span>
                  <i v-if="!isDisabled" class="icon_osp icon_ospclose closeIcon" :data-csname="`uploadFiles_${i}`" @click="removeFile(i)"></i>
                </span>
              </span>
              <el-empty
                v-if="!projectInfo.projectDocList || !projectInfo.projectDocList.length"
                style="padding:0;"
                image="oss_core/edesign/assets/image/no_data.png"
                :image-size="40"
                :description="$t('NO_DATA')"
              ></el-empty>
            </div>
          </el-form>
        </el-scrollbar>
      </div>
      <div class="planProjectBox">
        <div class="fromItemCard flex">
          <div class="cardContent planMapContentBox" :class="{ ospdisable: projectInfo.projectId }">
            <div style="width:100%;height:100%;" class="plan-container" ref="plan-container">
              <div id="osp"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="editProBtns">
      <el-button type="primary" size="mini" @click="saveFunc" v-if="!isDisabled" data-csname="projectEditSubmit"> {{ $t('NEXT') }}</el-button>
      <el-button type="primary" size="mini" @click="toNext" v-else data-csname="projectEditSubmit"> {{ $t('NEXT') }}</el-button>
    </div>
  </div>
</template>

<script>
import { queryDictList, qryProjectRegion, queryProjectDetail, queryMapNoByProjectId } from '@/oss_core/edesign/api/query/project.js';
import { insertProjectManagementData, addProjectImg } from '@/oss_core/edesign/api/add/project.js';
import { modifyProjectManagementData } from '@/oss_core/edesign/api/edit/project.js';
import { getAreaById } from '@/oss_core/edesign/api/query/address.js';
import html2canvas from 'html2canvas';

export default {
  name: 'ProjectEdit',
  components: {},
  inject: ['getControlData', 'getProjectInfo', 'getStepMaxNum'],
  data() {
    return {
      controlData: this.getControlData(),
      saveLoading: false,
      selecetResType: '',
      planGridParams: {},
      citySettingData: [],
      proTypeSettingData: [],
      hpTypeSettingData: [
        { name: 'P2P', code: 'P2P' },
        { name: 'P2MP', code: 'P2MP' },
      ],
      projManagerSetting: {
        name: '',
        code: '',
      }, //éæ©ç¨æ·éè¦çç»å®æ°æ®
      dsManagerSetting: {
        name: '',
        code: '',
      }, //éæ©ç¨æ·éè¦çç»å®æ°æ®
      projectInfo: this.getProjectInfo() || {},
      isDisabled: this.getStepMaxNum() > 2,
      // imgurl2: '',ç¼©ç¥å¾
      // imgurl: '',å¤§å¾
      isCoverImgUpload: '', //ä¸ä¼ å¾çå¤æ­ç¨
      formValue: {},
      rules: {
        projectName: [{ required: true, message: this.$t('PLEASE_ENTER') }],
        regionId: [{ required: true, message: this.$t('PLEASE_SELECT') }],
        extHpRedundancyRatio: [{ validator: this.validateRatio }],
        extCoverHps: [{ validator: this.validateHps }],
        extHpType: [{ required: true, message: this.$t('PLEASE_SELECT') }],
      },
    };
  },
  created() {},
  mounted() {
    queryDictList('EDN.OPERATION.TYPE').then(res => {
      this.proTypeSettingData = res.resultList || [];
      qryProjectRegion().then(data => {
        this.citySettingData = data.resultData || [];
        this.initData();

        fish.require(
          [
            'oss_core/edesign/view/plan.js',
            'oss_core/edesign/assets/config/edesign/themeConfig.js',
            'oss_core/edesign/assets/config/plan/menuConfig.js',
            'oss_core/edesign/assets/config/edesign/styleConfig.js',
          ],
          (plan, theme, menu, style) => {
            let options = Object.assign(theme, menu, style, {
              modalConfig: {
                initFunc: this.planInitFunc,
                selectGrid: this.selectGrid,
                sprintId: this.projectInfo && this.projectInfo.projectId,
                isModal: true,
              },
            });
            this.planView = plan.main(options);
          },
        );
      });
    });
    window.saveCoverImg = this.saveCoverImg;
    this.initWebUploader();
  },
  methods: {
    initData() {
      this.projectInfo = {
        projManagerId: portal.appGlobal.attributes.userId || '1',
        dsManagerId: portal.appGlobal.attributes.userId || '1',
        projectCode: Math.random() * 100000000000000000000 + '',
        extHpType: 'P2P',
        operationType: 'GreenField',
        projectDesc: this.projectInfo.notes,
        ...this.projectInfo,
      };
      (this.projectInfo.projectExtInfoList || []).map(item => {
        this.projectInfo[item.attrCode] = item.attrValue;
      });
      this.projectInfo = JSON.parse(JSON.stringify(this.projectInfo));
      this.formValue = {
        ...this.projectInfo,
        regionId: this.projectInfo.regionId ? `${this.projectInfo.regionId}` : '',
      };
    },
    validateRatio(rule, value, callback) {
      if (!Number(value)) {
        callback(new Error(this.$t('PROJECT_HP_REDUNDANCY_RATIO_ERROR_MSG')));
      } else if (Number(value) < 0 || Number(value) > 100) {
        callback(new Error(this.$t('PROJECT_HP_REDUNDANCY_RATIO_ERROR_MSG')));
      } else {
        callback();
      }
    },
    validateHps(rule, value, callback) {
      if (!Number(value) || !Number.isInteger(Number(value))) {
        callback(new Error(this.$t('PROJECT_COVER_HPS_ERROR_MSG')));
      } else if (Number(value) < 1 || Number(value) > 100000) {
        callback(new Error(this.$t('PROJECT_COVER_HPS_ERROR_MSG')));
      } else {
        callback();
      }
    },
    hpsChange(val) {
      let value = this.formValue;
      if (value.extCoverageArea) {
        let midu = value.extCoverageArea ? parseFloat(parseFloat(val || 0) / parseFloat(value.extCoverageArea)) : '';
        this.formValue = {
          ...this.formValue,
          extUserDensity: midu ? midu.toFixed(3) : '',
        };
      }
    },
    planInitFunc(plan) {
      this.$planRef = plan;
    },

    selectGrid(graphic, params) {
      this.selectGraphic = graphic;
      this.planGridParams = params;
      if (!params) {
        return;
      }
      let value = this.formValue;
      if (value.extCoverHps) {
        let midu = params.extCoverageArea ? parseFloat(parseFloat(value.extCoverHps || 0) / parseFloat(params.extCoverageArea)) : '';
        this.formValue = {
          ...this.formValue,
          ...params,
          extUserDensity: midu ? midu.toFixed(3) : '',
        };
      } else {
        this.formValue = {
          ...this.formValue,
          ...params,
        };
      }
    },
    saveFunc() {
      console.log('æäº¤...');
      this.$refs.editForm.validate(valid => {
        if (valid) {
          this.saveLoading = true;
          if (this.projectInfo && this.projectInfo.imgPath) {
            this.submitFunc();
          } else {
            console.log('æªå¾å¼å§...');
            this.saveCoverImg();
          }
        }
      });
    },
    submitFunc() {
      let value = this.formValue;
      value = {
        ...this.projectInfo,
        ...value,
      };
      delete value.upfile;
      let submitParams = { ...value };
      submitParams.projManagerId += '';
      submitParams.dsManagerId += '';
      submitParams.projectType = 'OPT';
      submitParams.prjDocList = (submitParams.projectDocList || []).map(item => {
        let newIt = {
          docPath: item.docPath,
          docType: item.docType,
          docName: item.docName,
        };
        if (item.docId) {
          newIt.docId = item.docId;
        }
        return newIt;
      });
      delete submitParams.projectDocList;
      let prjExtList = [];
      let extKeyList = ['extHpType', 'extHpRedundancyRatio', 'extCoverHps', 'extUserDensity', 'extCoverageArea'];
      for (let key in submitParams) {
        if (extKeyList.includes(key)) {
          prjExtList.push({
            attrCode: key,
            attrValue: submitParams[key],
          });
        }
      }
      prjExtList.forEach(it => {
        delete submitParams[it.attrCode];
      });
      submitParams.prjExtList = prjExtList;
      if (this.projectInfo && this.projectInfo.projectId) {
        //ç¼è¾æ¨¡å¼

        submitParams = {
          ...this.projectInfo,
          ...submitParams,
        };
        modifyProjectManagementData(submitParams).then(data => {
          this.saveLoading = false;
          if (data.projectId) {
            this.$message({
              message: this.$t('SAVE_SUCCESS'),
              type: 'success',
            });
            this.controlData.soltName = 'DesignPreparation';
          } else {
            this.$message({
              message: data.errorMessage,
              type: 'warning',
            });
          }
        });
      } else {
        if (!this.selectGraphic) {
          this.$message({
            message: this.$t('PROJECT_SELECT_PROJECT_MSG'),
            type: 'warning',
          });
          this.projectInfo.imgPath = null;
          this.saveLoading = false;
          return;
        }
        submitParams.projectState = 'O'; //æ°å»ºçå·¥ç¨ç¶æä¸ºOpen
        submitParams.designState = 'I'; //æ°å»ºçè®¾è®¡ç¶æä¸ºæªå¼å§
        submitParams.regionId += '';
        submitParams.partitionId = submitParams.regionId;
        submitParams.flowId = this.projectInfo.flowId;
        submitParams.gisKey = this.selectGraphic.attributes.gisKey;
        insertProjectManagementData(submitParams).then(data => {
          this.saveLoading = false;
          if (data.projectId) {
            this.projectInfo = {
              ...this.projectInfo,
              ...submitParams,
              projectId: data.projectId,
              hldPreTaskId: data.hldPreTaskId,
              projectExtInfoList: submitParams.prjExtList,
              notes: submitParams.projectDesc,
              projectDocList: submitParams.prjDocList,
            };
            this.selectGraphic.attributes = Object.assign(this.selectGraphic.attributes, {
              projectId: data.projectId,
              sprintId: data.projectId,
              resName: data.projectName,
            });

            this.$planRef.updateGridGeometry(this.selectGraphic); //æ´æ°gisåç´ çå±æ§
            this.$root.$emit('updateOption', 'projectId', data.projectId);
            this.$emit('changeProjectInfo', this.projectInfo);
            this.$message({
              message: this.$t('SAVE_SUCCESS') + '!',
              type: 'success',
            });
            this.controlData.soltName = 'DesignPreparation';
          } else {
            this.$message({
              message: data.errorMessage,
              type: 'warning',
            });
            this.$planRef.clearTaskNoId && this.$planRef.clearTaskNoId();
          }
        });
      }
    },
    toNext() {
      this.controlData.soltName = 'DesignPreparation';
    },
    projChooseUser(user) {
      if (user && user.name && user.value) {
        this.projectInfo.projManagerId = user.value;
        this.projManagerSetting.code = user.value;
        this.projManagerSetting.name = user.name;
      }
    },
    dsChooseUser(user) {
      if (user && user.name && user.value) {
        this.projectInfo.dsManagerId = user.value;
        this.dsManagerSetting.code = user.value;
        this.dsManagerSetting.name = user.name;
      }
    },
    uploadFile() {
      if (this.isDisabled) {
        return;
      }
      $('#uploadFileInput').click();
    },
    saveCoverImg() {
      const mapContent = document.querySelector('.planProjectBox .map-container .ol-unselectable');
      console.log('æªå¾åæ°ï¼', mapContent);
      html2canvas(mapContent, {
        width: mapContent.clientWidth, //ç»å¸çå®½
        height: mapContent.clientHeight, //ç»å¸çé«
        scale: 1, //å¤çæ¨¡ç³é®é¢
        useCORS: true, //å¼å¯è·¨åï¼è¿ä¸ªæ¯å¿é¡»ç
      })
        .then(canvas => {
          this.imgurl = canvas.toDataURL('image/png');
          const img = new Image();
          img.src = this.imgurl;
          img.onload = () => {
            const yscavas = document.createElement('canvas');
            yscavas.width = img.width / 2;
            yscavas.height = img.height / 2;
            const ctx = yscavas.getContext('2d');
            ctx.drawImage(img, 0, 0, yscavas.width, yscavas.height);
            this.imgurl2 = yscavas.toDataURL('image/jpeg');
            this.uploadFiles(this.imgurl);
          };
          img.onerror = () => {
            console.log('imageå è½½å¤±è´¥...');
            this.submitFunc();
            this.saveLoading = false;
          };
        })
        .catch(() => {
          console.log('æªå¾å¤±è´¥...');
          this.submitFunc();
          this.saveLoading = false;
        });
    },
    dataURLtoBlob(dataurl) {
      var arr = dataurl.split(','),
        mime = arr[0].match(/:(.*?);/)[1],
        bstr = atob(arr[1]),
        n = bstr.length,
        u8arr = new Uint8Array(n);
      while (n--) {
        u8arr[n] = bstr.charCodeAt(n);
      }
      return new Blob([u8arr], { type: mime });
    },
    uploadFiles(src) {
      this.isCoverImgUpload = this.isCoverImgUpload || 1;
      let file = this.dataURLtoBlob(src);
      this.uploader.addFiles([file]);
    },
    chooseFile(e) {
      // ä¸ä¼ éä»¶
      let files = e.target.files;
      this.uploader.addFiles(files); //æ·»å å°ä¸ä¼ æä»¶éåä¸­
      e.target.value = '';
    },
    initWebUploader() {
      let webuploader = require('webuploader');
      this.uploader = webuploader.create({
        swf: 'frm/fish-desktop/third-party/webupload/Uploader.swf',
        // server: portal.appGlobal.attributes.webroot + '/im/webgis/file/upload?moduleName=im&date=true&temporary=true', //ä¸ä¼ æ¥å£å°å
        server: portal.appGlobal.attributes.webroot + '/opb/file/upload?moduleName=im&date=true&temporary=true', //ä¸ä¼ æ¥å£å°å
      });

      //æä»¶å å¥éååçåè°å½æ°
      this.uploader.on('beforeFileQueued', file => {});
      //å½æä»¶è¢«å å¥éåä»¥åè§¦åã
      this.uploader.on('fileQueued', file => {
        this.uploader.upload();
      });
      this.uploader.on('filesQueued', files => {
        this.uploader.upload();
      });
      // æä»¶ä¸ä¼ è¿ç¨ä¸­
      this.uploader.on('uploadProgress', (file, percentage) => {
        $.blockUI({ message: 'loading' }); // loading
      });
      // æä»¶ä¸ä¼ æå
      this.uploader.on('uploadSuccess', (file, response) => {
        if (this.isCoverImgUpload) {
          this.coverPostFile(response);
        } else {
          this.postFile(response);
          $.unblockUI(); //  loading
          this.$message({
            message: this.$t('UPLOAD_SUCCESS'),
            type: 'success',
          });
        }
      });
      //æä»¶ä¸ä¼ éè¯¯
      this.uploader.on('uploadError', (file, reason) => {
        $.unblockUI(); //  loading
        this.saveLoading = false;
        this.$message({
          message: (reason && reason.message) || this.$t('AJAX_ERROR'),
          type: 'error',
        });
      });
      //æä»¶ä¸ä¼ å®æ
      this.uploader.on('uploadComplete', (file, response) => {
        this.uploader.removeFile(file, true);
      });
    },
    coverPostFile(reason) {
      const img_path = `${reason.filePath.substr(1)}/${reason.fileName}`;
      if (this.isCoverImgUpload === 1) {
        this.isCoverImgUpload = 2;
        this.projectInfo.imgPath = img_path;
        this.uploadFiles(this.imgurl2);
      } else if (this.isCoverImgUpload === 2) {
        this.isCoverImgUpload = 0;
        this.projectInfo.thumbnailPath = img_path;
        $.unblockUI(); //  loading
        this.submitFunc();
      }
    },
    postFile(reason) {
      let typest = reason.fileName.split('.');
      let path = encodeURIComponent(reason.filePath.slice(1) + '/' + reason.fileName);
      this.projectInfo.projectDocList = this.projectInfo.projectDocList || [];
      this.projectInfo.projectDocList.push({
        docPath: `${portal.appGlobal.get('webroot')}/opb/file/download?fileName=${path}&delete=true`,
        docType: typest[typest.length - 1],
        docName: reason.fileName,
      });
      this.projectInfo = JSON.parse(JSON.stringify(this.projectInfo));
    },
    removeFile(index) {
      if (this.isDisabled) {
        return;
      }
      this.projectInfo.projectDocList.splice(index, 1);
    },
    changeArea(val) {
      if (!val) {
        return;
      }
      getAreaById(val).then(res => {
        let objs = {
          x: res.longitude,
          y: res.latitude,
        };
        this.$planRef.centerAt(objs);
      });
    },
  },
  // watch: {
  //     show: {
  //         deep: true,
  //         immediate: true,
  //         handler(val, old) {
  //             if (val) {
  //                 this.initStep();
  //             }
  //         },
  //     },
  // },
  destroyed() {
    if (this.planView) {
      this.planView.$destroy();
    }
  },
};
</script>

<style lang="scss" scoped>
@import './projectEdit.scss';
</style>
